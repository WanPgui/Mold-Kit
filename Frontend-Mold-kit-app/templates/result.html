{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">

  <!-- User Info -->
  <div class="user-info mb-3">
    {% if session.get('email') %}
      Logged in as {{ session.get('email') }} |
      <a href="{{ url_for('logout') }}">Logout</a>
    {% else %}
      <a href="{{ url_for('login') }}">Login</a> |
      <a href="{{ url_for('register') }}">Register</a>
    {% endif %}
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">

      <div class="card shadow p-4 border-0 animate__animated animate__fadeIn">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="fw-bold"><i class="bi bi-activity"></i> Mold Prediction Result</h3>
          <a href="{{ url_for('predict_page') }}" class="btn btn-outline-primary">
            <i class="bi bi-upload"></i> Upload Another
          </a>
        </div>

        <div class="row g-4">
          <!-- Uploaded Image -->
          <div class="col-md-6 text-center">
            <img src="{{ url_for('uploaded_file', filename=filename) }}"
                 class="img-fluid rounded shadow-sm border animate__animated animate__fadeIn"
                 alt="Uploaded Image">
            <div class="mt-3">
              <small class="text-muted">Uploaded: <strong>{{ filename }}</strong></small>
            </div>

            <!-- Confidence Bar -->
            <div class="mt-4">
              <label class="form-label mb-1">Confidence Level:</label>
              <div class="progress" style="height: 25px;">
                <div class="progress-bar {% if confidence > 0.7 %}bg-success{% elif confidence > 0.4 %}bg-warning{% else %}bg-danger{% endif %}"
                     role="progressbar"
                     style="width: 0%;" id="confidenceBar">
                  {{ '%.1f'|format(confidence * 100) }}%
                </div>
              </div>
            </div>
          </div>

          <!-- Environmental Panel + Grad-CAM Side-by-Side -->
          <div class="col-md-6">
            <div class="row g-3">

              <!-- Environmental Panel -->
              {% if result %}
              <div class="col-12">
                <div class="p-3 rounded shadow-sm" style="background-color: #f8f9fa;">
                  <h6><i class="bi bi-cloud-sun"></i> Environmental Panel</h6>
                  <p class="mb-1"><strong>Weather:</strong> {{ result.weather }}</p>
                  <p class="mb-1"><strong>Ventilation:</strong> {{ result.ventilation }}</p>
                  <p class="mb-1"><strong>Leak detected:</strong> {{ result.leak }}</p>
                  <p class="mb-1"><strong>Health symptoms:</strong> {{ result.symptoms }}</p>

                  <p class="mt-2">
                    <strong>Final Status:</strong>
                    {% if result.final_status == 'high' %}
                      <span class="badge bg-danger fs-6">ðŸ”´ HIGH RISK</span>
                    {% elif result.final_status == 'moderate' %}
                      <span class="badge bg-warning fs-6">ðŸŸ¡ MODERATE RISK</span>
                    {% else %}
                      <span class="badge bg-success fs-6">ðŸŸ¢ SAFE</span>
                    {% endif %}
                  </p>

                  <p class="small text-muted mb-0">
                    Mold risk is influenced by humidity, ventilation, leaks, and health symptoms. Take precautions accordingly.
                  </p>
                </div>
              </div>
              {% endif %}

              <!-- Grad-CAM Heatmap -->
              <div class="col-12">
                <div class="p-3 rounded shadow-sm" style="background-color: #f8f9fa;">
                  <h6><i class="bi bi-brain"></i> Model Explainability</h6>
                  <p class="small text-muted">Heatmap shows regions the model focused on. Brighter areas indicate potential mold patterns.</p>
                  <div class="d-flex align-items-center gap-3 flex-wrap">
                    <img src="{{ url_for('static', filename='gradcam/' + filename + '.jpg') }}"
                         class="rounded img-thumbnail" style="width: 100%; max-width: 300px;"
                         alt="Grad-CAM Heatmap"
                         onerror="this.style.display='none'">

                    {% if explain %}
                    <a href="{{ url_for('explain', filename=filename) }}"
                       class="btn btn-sm btn-outline-info mt-2" target="_blank">
                      <i class="bi bi-eye"></i> View Detailed Heatmap
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>

        <!-- Print / Download -->
        <div class="mt-4 d-flex gap-2 flex-wrap">
          <a href="{{ url_for('print_report', filename=filename) }}"
             target="_blank"
             class="btn btn-outline-secondary">
            <i class="bi bi-printer"></i> Print Report
          </a>

          {% if download_report %}
          <a href="{{ url_for('download_report', filename=filename) }}"
             class="btn btn-outline-success" target="_blank">
            <i class="bi bi-download"></i> Download Report
          </a>
          {% endif %}
        </div>

        <!-- Feedback Section -->
        {% if session.get('user_id') %}
        <div class="mt-5 border-top pt-4">
          <h5><i class="bi bi-chat-left-text"></i> Feedback</h5>
          <p class="small text-muted">Help improve the model by confirming or correcting the prediction:</p>
          <form method="post" action="{{ url_for('feedback', filename=filename) }}">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="feedback" value="correct" id="fbCorrect" required>
              <label class="form-check-label" for="fbCorrect">Prediction is correct</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="feedback" value="incorrect" id="fbIncorrect">
              <label class="form-check-label" for="fbIncorrect">Prediction is incorrect</label>
            </div>
            <div class="mt-3">
              <textarea class="form-control" name="comment" rows="2" placeholder="Additional comments (optional)"></textarea>
            </div>
            <button class="btn btn-primary mt-3"><i class="bi bi-send"></i> Submit Feedback</button>
          </form>
        </div>
        {% else %}
        <div class="alert alert-warning mt-4">
          <strong>Login required to give feedback.</strong> Please
          <a href="{{ url_for('login') }}">log in</a> or
          <a href="{{ url_for('register') }}">register</a>.
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<!-- Confidence Bar Animation -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const bar = document.getElementById("confidenceBar");
  const target = {{ (confidence * 100) | round(1) }};
  let width = 0;
  const interval = setInterval(() => {
    if (width >= target) { clearInterval(interval); return; }
    width += 1;
    bar.style.width = width + "%";
    bar.innerText = width + "%";
  }, 15);
});
</script>

<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}
