<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mold Prediction Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #fff; color: #000; margin: 2rem; font-family: 'Segoe UI', sans-serif; }
    .report-header { text-align: center; margin-bottom: 2rem; }
    .report-header h2 { font-weight: bold; }
    .img-preview { max-width: 350px; border-radius: 10px; }
    .summary, .advisory, .environment, .gradcam, .feedback, .notes { border-top: 2px solid #000; margin-top: 2rem; padding-top: 1rem; }
    .badge { font-size: 1rem; }
    .section-title { font-weight: bold; margin-bottom: 0.5rem; }
    @media print { .no-print { display: none; } }
  </style>
</head>
<body onload="window.print()">

  <!-- Report Header -->
  <div class="report-header">
    <h2><i class="bi bi-activity"></i> Mold Prediction Report</h2>
    <p class="text-muted">Generated on {{ datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC') }}</p>
    <p class="text-muted"><strong>Generated by:</strong> {{ session.get('email', 'Guest') }}</p>
  </div>

  <!-- Image Preview -->
  <div class="text-center mb-4">
    <img src="{{ url_for('uploaded_file', filename=filename) }}" class="img-preview shadow-sm" alt="Uploaded Image">
    <p class="text-muted mt-2"><strong>Filename:</strong> {{ filename }}</p>
  </div>

  <!-- Prediction Summary -->
  <div class="summary">
    <h5 class="section-title">Prediction Summary</h5>
    <p><strong>Result:</strong>
      {% if label == 'mold' %}
        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i> Mold Detected</span>
      {% else %}
        <span class="badge bg-success"><i class="bi bi-check-circle"></i> Clean</span>
      {% endif %}
    </p>
    <p><strong>Confidence:</strong> {{ '%.1f'|format(confidence * 100) }}%</p>
    <p><strong>Final Assessment:</strong>
      {% if final_status == 'high' %}
        <span class="badge bg-danger">High Risk ðŸ”´</span>
      {% elif final_status == 'medium' %}
        <span class="badge bg-warning text-dark">Medium Risk ðŸŸ¡</span>
      {% else %}
        <span class="badge bg-success">Low Risk ðŸŸ¢</span>
      {% endif %}
    </p>
  </div>

  <!-- Environmental Context -->
  <div class="environment">
    <h5 class="section-title">Environmental Context</h5>
    <p><strong>Temperature:</strong> {{ env.temperature }}Â°C</p>
    <p><strong>Humidity:</strong> {{ env.humidity }}%</p>
    <p><strong>Ventilation:</strong> {{ env.ventilation }}</p>
    <p><strong>Leaks:</strong> {{ env.leaks }}</p>
    <p><strong>Health Symptoms Reported:</strong> {{ env.symptoms or 'None' }}</p>
    <p class="small text-muted">
      High humidity, poor ventilation, and water leaks increase mold growth risk. Monitor environment regularly.
    </p>
  </div>

  <!-- Grad-CAM Heatmap -->
  <div class="gradcam text-center">
    <h5 class="section-title">Grad-CAM Heatmap</h5>
    <img src="{{ url_for('static', filename='gradcam/' + filename + '.jpg') }}" 
         class="img-preview shadow-sm" alt="Grad-CAM Heatmap" onerror="this.style.display='none'">
  </div>

  <!-- Health Advisory -->
  <div class="advisory">
    <h5 class="section-title">Health Advisory</h5>
    {% if label == 'mold' %}
      <ul>
        <li>Mold detected. Improve ventilation and remove moisture immediately.</li>
        <li>Use antifungal cleaning agents and inspect walls, ceilings, or furniture for leaks.</li>
        <li>Prolonged exposure may cause allergies, coughing, or respiratory issues.</li>
        <li>Consider professional remediation if mold is widespread.</li>
      </ul>
    {% else %}
      <ul>
        <li>No mold detected. Maintain humidity between 30â€“50%.</li>
        <li>Keep surfaces dry and clean; inspect periodically.</li>
        <li>Good ventilation reduces the risk of mold growth.</li>
      </ul>
    {% endif %}
  </div>

  <!-- User Feedback -->
  {% if feedbacks %}
  <div class="feedback">
    <h5 class="section-title">User Feedback</h5>
    {% for fb in feedbacks %}
      <div class="border rounded p-2 mb-2">
        <strong>{{ fb.feedback|capitalize }}</strong>{% if fb.comment %}: {{ fb.comment }}{% endif %}
        <div class="text-muted small">Submitted at {{ fb.submitted_at[:19] }}</div>
      </div>
    {% else %}
      <p class="text-muted">No feedback submitted.</p>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Optional Notes -->
  {% if notes %}
  <div class="notes">
    <h5 class="section-title">Additional Notes</h5>
    <p>{{ notes }}</p>
  </div>
  {% endif %}

  <!-- Print Controls -->
  <div class="text-center mt-5 no-print">
    <a href="javascript:window.close()" class="btn btn-outline-secondary"><i class="bi bi-x-lg"></i> Close</a>
  </div>

</body>
</html>
